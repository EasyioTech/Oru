---
alwaysApply: true
---
## Database Connection (CRITICAL - Use These Exactly)
- Database: buildflow_db
- User: postgres
- Password: admin
- Always verify connection before starting any work

## Pre-Development Checklist
1. FIRST: Connect to DB and fetch ALL table schemas (names, columns, types, constraints)
2. Verify foreign key relationships between tables
3. Check existing indexes and primary keys
4. Never assume structure - always query information_schema first

## Backend Rules
- Create ONE central DB config file with connection details
- Build models that EXACTLY match DB table structures
- Generate API endpoints: GET (all/single), POST, PUT, PATCH, DELETE for each table
- Add proper error handling with specific DB error messages
- Include data validation matching DB constraints (NOT NULL, UNIQUE, etc)
- Use transactions for multi-table operations
- Return consistent JSON responses: {success, data/error, message}

## Frontend Rules
- Check backend health endpoint on app load
- Fetch and display actual table data on mount
- Build forms with fields matching exact DB columns and types
- Show loading states during API calls
- Display clear error messages from backend
- Implement optimistic UI updates with rollback on failure
- Add confirmation dialogs for DELETE operations

## Query Handling
- Use parameterized queries (NEVER string concatenation)
- Add proper WHERE clauses for filtering
- Implement pagination for large datasets
- Include search functionality on text columns
- Add sorting capabilities on table columns

## Testing Protocol
- Test each CRUD operation immediately after creation
- Verify data appears in DB after POST/PUT
- Check frontend displays DB changes in real-time
- Test error scenarios (duplicate keys, constraint violations)
- Validate form inputs match DB requirements

## Auto-Fix Rule
If ANY operation fails: Stop, check DB schema again, compare with code, fix mismatch, then continue.

## Directory Structure (Authoritative)
New files must be placed in the directory that matches their responsibility. No misc or temp folders.

### Frontend (frontend/src)
- **config**: env, API base URL, features, external services
- **core/auth**: ProtectedRoute, AuthRedirect (auth guard / redirect)
- **core/layout**: ErrorBoundary, ScrollToTop, MaintenanceMode, ThemeSync, ServiceUnavailable
- **components/ui**: shadcn/ui primitives only
- **components/layout**: DashboardLayout, dashboard-shell (sidebar, header)
- **components/auth**: TwoFactorSetup, TwoFactorVerification, UserFormDialog, ViewAsUserBanner
- **components/shared**: cross-feature dialogs/panels (TicketFloatingButton, QuickActionsPanel, InvoiceFormDialog, TaskFormDialog, HolidayFormDialog, etc.)
- **components/landing**, **onboarding**, **super-admin**, **system**, **gst**, **crm**, etc.: feature-specific components
- **hooks**: all React hooks (use-mobile, use-toast, useAuth, etc.); single sourceâ€”no duplicate under lib/hooks
- **lib**: pure shared utilities only (utils.ts, uuid, hexId, etc.); no React
- **pages**: route targets (flat or by feature subfolder)
- **routes**: index, lazyImports, routeGroups, SuspenseRoute
- **services**: API clients (services/api/*), audit, file-storage, permissions, reports, system-*
- **stores**, **types**, **utils**: app-specific state, types, helpers
- **integrations**: HTTP clients for external/backend APIs (e.g. postgresql client-http)
- **contexts**, **test**: React contexts, test setup
- **No docs or tooling under src**: documentation lives in frontend/docs (or repo docs/frontend); build-time tooling (e.g. visual-edits) lives in frontend/tooling

### Backend (backend/src)
- **config**: constants, database (re-exports pool from infrastructure), middleware, ports, redis
- **middleware**: authMiddleware, errorHandler, rateLimiter, validation, etc.
- **routes**: thin routers only; delegate to services
- **services**: business logic; **services/auth** for login/tokens/user resolution; **services/agency** for agency creation/provisioning/repair
- **infrastructure/database**: poolManager, dbQuery, transactionHelper, schema (DDL modules), schemaCreator, schemaSyncService, schemaValidator
- **utils**: non-DB helpers only (logger, paginationHelper, responseHelper, securityUtils, systemSettings)
- **graphql**, **scripts**: GraphQL schema, one-off scripts
- Auth lives under **services/auth/**; schema and DB runtime live under **infrastructure/database/**; routes are thin and delegate to services.