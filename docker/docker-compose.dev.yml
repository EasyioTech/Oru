# ============================================================================
# BuildFlow ERP - Development Docker Compose
# ============================================================================
# Hot-reloading enabled for both frontend and backend
# Run from project root: docker-compose -f docker/docker-compose.dev.yml up
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # PostgreSQL Database
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: buildflow-postgres-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword123}
      POSTGRES_DB: buildflow_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
      - ../backend/database/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - buildflow-dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --------------------------------------------------------------------------
  # Redis Cache
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: buildflow-redis-dev
    command: redis-server --appendonly yes
    volumes:
      - redis_data_dev:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - buildflow-dev
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------------
  # Backend API - Development with Hot Reload
  # --------------------------------------------------------------------------
  backend:
    image: node:20-alpine
    container_name: buildflow-backend-dev
    working_dir: /app
    environment:
      NODE_ENV: development
      PORT: ${BACKEND_PORT:-3000}
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-devpassword123}@postgres:5432/buildflow_db
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword123}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      APP_NAME: BuildFlow ERP
      API_URL: http://localhost:3000/api
      FRONTEND_URL: http://localhost:5173
      CORS_ORIGINS: http://localhost:5173,http://localhost:5174,http://localhost:3000
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production-min-32-chars}
      FILE_STORAGE_PATH: /app/storage
    volumes:
      - ../backend/src:/app:delegated
      - ../backend/package.json:/app/package.json:ro
      - backend_node_modules:/app/node_modules
      - backend_storage_dev:/app/storage
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - buildflow-dev
    command: sh -c "npm install && npm run dev"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # --------------------------------------------------------------------------
  # Frontend - Development with Hot Reload
  # --------------------------------------------------------------------------
  frontend:
    image: node:20-alpine
    container_name: buildflow-frontend-dev
    working_dir: /app
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:3000/api
      VITE_APP_NAME: BuildFlow ERP
      VITE_APP_ENVIRONMENT: development
      VITE_DEV_SERVER_HOST: 0.0.0.0
      VITE_DEV_SERVER_PORT: 5173
    volumes:
      - ../frontend:/app:delegated
      - frontend_node_modules:/app/node_modules
      - /app/dist
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    depends_on:
      - backend
    networks:
      - buildflow-dev
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5173 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 45s

# ============================================================================
# Networks
# ============================================================================
networks:
  buildflow-dev:
    driver: bridge
    name: buildflow-dev

# ============================================================================
# Volumes
# ============================================================================
volumes:
  postgres_data_dev:
    name: buildflow-postgres-dev
  redis_data_dev:
    name: buildflow-redis-dev
  backend_storage_dev:
    name: buildflow-storage-dev
  backend_node_modules:
    name: buildflow-backend-modules
  frontend_node_modules:
    name: buildflow-frontend-modules
